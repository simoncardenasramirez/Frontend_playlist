<div class="page">

  <header class="page__header">
    <h1>Listas de reproducción</h1>
    <div class="header__actions">
      <button class="btn btn--ghost" (click)="cargarListas()">↻ Actualizar</button>
      <button class="btn btn--primary" (click)="toggleCrear()">＋ Crear lista</button>
      <button class="btn btn--danger" (click)="logout()">Cerrar sesión</button>
    </div>
  </header>

  <!-- MENSAJE DE ERROR LISTADO -->
  <div *ngIf="errorList" class="alert alert--error">{{ errorList }}</div>

  <!-- TARJETAS DE LISTAS -->
  <section class="grid" *ngIf="!loadingList">
    <article class="card" *ngFor="let l of listas">
      <h3>{{ l.nombre }}</h3>
      <p class="muted">{{ l.descripcion || 'Sin descripción' }}</p>
      <div class="actions">
        <button class="btn btn--primary" (click)="verDetalle(l.nombre)">Abrir detalle</button>
        <button class="btn btn--danger" (click)="eliminar(l.nombre)">Eliminar</button>
      </div>
    </article>
  </section>

  <div class="loading" *ngIf="loadingList">Cargando listas…</div>

  <!-- PANEL CREAR -->
  <section class="panel" *ngIf="crearVisible">
    <h2>Nueva lista</h2>

    <form [formGroup]="form" (ngSubmit)="crearLista()">
      <label>Nombre *</label>
      <input formControlName="nombre" placeholder="Mi Lista X" />
      <small class="error" *ngIf="form.get('nombre')?.touched && form.get('nombre')?.invalid">
        Requerido (mín 3)
      </small>

      <label>Descripción</label>
      <input formControlName="descripcion" placeholder="Descripción (opcional)" />

      <h3>Canciones</h3>
      <div class="song" formArrayName="canciones" *ngFor="let s of canciones.controls; let i = index">
        <div [formGroupName]="i" class="song__row">
          <input placeholder="Título *" formControlName="titulo" />
          <input placeholder="Artista *" formControlName="artista" />
          <input placeholder="Álbum" formControlName="album" />
          <input placeholder="Año" formControlName="anno" />
          <input placeholder="Género" formControlName="genero" />
          <button type="button" class="btn btn--ghost" (click)="removeSong(i)" [disabled]="canciones.length === 1">–</button>
        </div>
      </div>

      <div class="song__actions">
        <button type="button" class="btn btn--ghost" (click)="addSong()">＋ Añadir canción</button>
      </div>

      <button class="btn btn--primary" type="submit" [disabled]="loadingCreate">
        {{ loadingCreate ? 'Creando…' : 'Crear lista' }}
      </button>
      <div class="muted" *ngIf="messageCreate">{{ messageCreate }}</div>
    </form>
  </section>

  <!-- DETALLE -->
  <section class="detail" *ngIf="seleccion">
    <header class="detail__header">
      <div>
        <h2>{{ seleccion?.nombre }}</h2>
        <p class="muted">{{ seleccion?.descripcion || 'Sin descripción' }}</p>
      </div>
    </header>

    <div *ngIf="loadingDetail" class="loading">Cargando detalle…</div>
    <div *ngIf="errorDetail" class="alert alert--error">{{ errorDetail }}</div>

    <table class="songs" *ngIf="!loadingDetail && seleccion?.canciones?.length">
      <thead>
      <tr>
        <th>#</th><th>Título</th><th>Artista</th><th>Álbum</th><th>Año</th><th>Género</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let c of seleccion!.canciones!; let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ c.titulo }}</td>
        <td>{{ c.artista }}</td>
        <td>{{ c.album || '—' }}</td>
        <td>{{ c.anno || '—' }}</td>
        <td>{{ c.genero || '—' }}</td>
      </tr>
      </tbody>
    </table>

    <div class="muted" *ngIf="!loadingDetail && (!seleccion?.canciones || !seleccion.canciones?.length)">
      Esta lista no tiene canciones.
    </div>
  </section>

</div>
